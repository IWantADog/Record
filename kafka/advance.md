# 使用细节

## 再均衡（re-assignment）

再均衡会导致当前分组消费者的状态的丢失。也就是说发生再均衡时，消费者没有及时的提交偏移量，会导致再均衡之后，新的消费者拿到已经被消费的数据，导致数据重复被消费。

为了处理这个问题，客户端包一般会提供如下两个api
- on_revoked: 

  该方法会在再均衡还是之前和消费者停止读取消息之后被调用。在这里提交偏移量，新的消费者就能知道从哪里继续读取数据。
- on_assigned:

  该方法会在再均衡完成之后和新的消费者开始读取消息之前被调用。


## kafka数据的有序性

kafka无法保证消费事件时的全局有序性（横跨所有分区）。kafka只能保证数据在一个分区上是有序的。

## 可靠的数据传输

### 复制

kafka的主题被分为多个分区。每个分区有多个副本，其中一个副本为leader。所有的事件的写入和读取都会直接发送给leader副本。其他follower副本仅仅保持和leader的数据同步。当leader副本不可用时，会从所有follower副本中选举一个新leader。

### broker的一些概念

- 复制系数

  复制系数为N，意味着至少需要N歌broker，同时会有N个数据副本。

  复制系数越高，会带来更高的可用性、可靠性和更小的故障。不过也会消耗更多的磁盘空间。

- 不完全的leader选举

  当leader副本不可用时，一个follower副本就会被选举为新leader。如果选举过程中没有数据丢失，则称这次选举被称为完全的leader选举。

  而如果leader选举时，所有的follower副本的数据都不完整，也就意味着数据的丢失。如果这时候不同意`不完全的leader选举`，则只能等待原先的leader副本重新上线，这样就降低了可用性。

  而如果同意`不完全的leader选举`，则提高了可用性，但可能出现数据的不一致的情况。

  需要根据实际的业务进行权衡。**不完全的leader选举其实是数据一致性和服务可用性之间的权衡**

- mini.insync.replicas

  当acks=all时，如果ISR中的数量小于mini，则producer写入数据会抛出异常。

### producer的一些参数

- acks

  控制生产者写入一个消息时，必须要有N个分区副本收到消息之后，消息被认为成功提交。

  acks=0: 不等待任何其他响应，直接视为数据提交成功

  acks=1: leader分区数据写入成功，则消息被视为提交成功

  acks=all: 消息被写入所有的ISR，才被视为提交成功。
