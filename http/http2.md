# about http/2

## 基础概念

- 二进制协议
- 多路复用
- 流量控制功能
- 数据流优先级
- 首部压缩
- 服务器推送

### 二进制协议

http/2是一个基于二进制的、基于数据包的协议，而http/1是完全基于文本的。

使用基于文本的协议，要先发完请求，并接收完响应之后，才能开始下一个请求。

http/2是一个二进制协议，http消息被分为清晰定义的数据帧发送。这里的帧和支撑http连接的tcp数据包类似。当收到所有的数据帧后，可以将它们组合为完整的http消息。

### 多路复用代替同步请求

http/1是一种同步的、独占的请求-响应协议。

http/2允许在单个连接上同时执行多个请求，**每个HTTP请求或相应使用不同的流**。**通过使用二进制分帧流，给每个帧分配一个流标识符，以支持同时发出多个独立的请求。当接收到该流的所有帧时，接收方可以将帧组合成完整消息**。

每个请求都有一个新的、自增的流ID。返回响应时使用相同的流ID。

为了防止流ID冲突，客户端发起的请求使用奇数流，服务器发起的请求使用偶数流。ID为0的流是客户端和服务器用于管理连接的控制流。

TODO: http/2使用一个tcp链接，能同时收发数据吗？

### 流的优先级及流量控制

TODO:

### 首部压缩

### 服务器推送

## 建立http/2的方式

- http2协商
- 使用http的Upgrade首部
- 和之前的连接保持一致

TODO: 先跳过，后续详读一下

### 数据帧

TODO:

## http/2推送

**http/2服务端推送允许服务器发回客户端未请求的额外资源**。

需要注意的是，仅在响应初始请求时才会发送推送的资源。是否推送完全取决于服务器。

### 如何推送

使用HTTP link首部推送
- web server推送
  - 推送的link通常包含在条件语句中，以支持仅对指定的路径或文件类型推送资源。
- application推送
  - 由app控制link。当请求url时，app主动在响应中添加link header。之后web server接到响应后，获取link对应的静态资源，和响应一同返回。

  这样做的优势是，推送资源的控制逻辑在一个地方，不需要同时修改app和web server。

更早推送

更早推送使用的场景是：当app的响应需要较长的时间，而推送的资源大多为静态资源，完全可以提前返回。当app响应完毕之后，可以立即渲染数据。

处理方式
- web server进行处理(例如`H2PushResource`功能)
  - 不过app就无法控制是否推送了
- application处理
  - 103状态码，app先返回一个103响应，包含link的信息。之后再一个200响应，返回实际的数据。
  - 支持的不多

### http/2推送在浏览器中如何运作

- 资源不是被直接推到网页中，而是推到缓存中。和平时处理网页一样。当页面知道它需要什么资源时，它先查看缓存，如果发现缓存中有，就直接从缓存中加载，而不需要想服务端请求。
- 在浏览器中有一个单独的**http/2推送缓存**，区别于http缓存。

  如果http cache-control首部设置了缓存，则可以从浏览器http缓存中获取。推送缓存还有一点和http缓存不同，在http cache-control header中设置了`no-cache`和`no-store`被推送之后，可以在推送缓存中读取到他们。
- http/2推送缓存和连接绑定，这就意味着如果连接关闭，推送资源也就无法使用了

### 推送什么

- 只有get请求会被推送。
- 应该时刻牢记，推送是用来做性能优化的。如果推送过多，或是推送不重要的数据，反而会降低性能。
- 应该只推送关键资源。
- 少推比多推好。

